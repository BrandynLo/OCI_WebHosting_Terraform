---
- name: Production Public LAMP + PostgreSQL 16 + Full Auto Updates (A1/Flex Ready)
  hosts: all
  become: yes
  vars:
    ansible_ssh_pipelining: true

  tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Add PostgreSQL APT signing key
      ansible.builtin.get_url:
        url: https://www.postgresql.org/media/keys/ACCC4CF8.asc
        dest: /etc/apt/trusted.gpg.d/pgdg.asc
        mode: '0644'

    - name: Add PostgreSQL repository
      ansible.builtin.apt_repository:
        repo: "deb https://apt.postgresql.org/pub/repos/apt {{ ansible_distribution_release }}-pgdg main"
        state: present
        filename: pgdg
        update_cache: yes

    - name: Install Apache, PHP, PostgreSQL 16 and tools
      ansible.builtin.apt:
        name:
          - apache2
          - php
          - libapache2-mod-php
          - php-pgsql
          - postgresql-16
          - git
          - unattended-upgrades
          - apache2-utils
          - iptables-persistent
        state: present
        update_cache: yes

    - name: Remove the default REJECT-all rule that blocks HTTP
      ansible.builtin.iptables:
        chain: INPUT
        jump: REJECT
        reject_with: icmp-host-prohibited
        state: absent
      ignore_errors: yes

    - name: Save iptables rules so the fix survives reboot
      ansible.builtin.command: netfilter-persistent save
      when: ansible_os_family == "Debian"

    - name: Find active php.ini used by Apache
      ansible.builtin.find:
        paths: /etc/php
        patterns: php.ini
        recurse: yes
        file_type: file
      register: php_ini_search

    - name: Set php_ini_path fact
      ansible.builtin.set_fact:
        php_ini_path: "{{ php_ini_search.files[0].path }}"

    - name: Verify php.ini was found
      ansible.builtin.assert:
        that: php_ini_search.matched > 0
        fail_msg: "No php.ini found – something is very wrong"

    - name: Harden PHP (disable dangerous functions + hide version)
      ansible.builtin.lineinfile:
        path: "{{ php_ini_path }}"
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
      loop:
        - { regexp: '^;?disable_functions', line: 'disable_functions = exec,passthru,shell_exec,system,proc_open,popen,curl_exec,curl_multi_exec,parse_ini_file,show_source' }
        - { regexp: '^;?expose_php', line: 'expose_php = Off' }
      notify: Restart Apache

    - name: Ensure Apache listens on all interfaces port 80
      ansible.builtin.replace:
        path: /etc/apache2/ports.conf
        regexp: '^Listen\s+.*$'
        replace: 'Listen 80'
      notify: Restart Apache

    - name: Enable default virtual host
      ansible.builtin.command: a2ensite 000-default
      args:
        creates: /etc/apache2/sites-enabled/000-default.conf
      notify: Restart Apache

    - name: Enable required Apache modules
      ansible.builtin.apache2_module:
        name: "{{ item }}"
        state: present
      loop:
        - rewrite
        - headers
      notify: Restart Apache

    - name: Apache minimal security config
      ansible.builtin.copy:
        dest: /etc/apache2/conf-enabled/security.conf
        content: |
          ServerTokens Prod
          ServerSignature Off
          TraceEnable Off
          Header unset ETag
          FileETag None
          <Directory /var/www/>
            Options -Indexes +FollowSymLinks
            AllowOverride All
          </Directory>
        mode: '0644'
      notify: Restart Apache

    - name: Modern security headers (2025 best practice)
      ansible.builtin.copy:
        dest: /etc/apache2/conf-enabled/headers.conf
        content: |
          Header always set X-Content-Type-Options "nosniff"
          Header always set X-Frame-Options "DENY"
          Header always set Referrer-Policy "strict-origin-when-cross-origin"
          Header always set Content-Security-Policy "default-src 'self'; script-src 'self'; object-src 'none'; frame-ancestors 'none';"
          Header always set Permissions-Policy "geolocation=(), microphone=()"
        mode: '0644'
      notify: Restart Apache

    - name: Configure unattended-upgrades
      ansible.builtin.copy:
        dest: /etc/apt/apt.conf.d/50unattended-upgrades
        content: |
          Unattended-Upgrade::Allowed-Origins {
            "${distro_id}:${distro_codename}";
            "${distro_id}:${distro_codename}-security";
            "${distro_id}:${distro_codename}-updates";
          };
          Unattended-Upgrade::Package-BlackList {};
          Unattended-Upgrade::Automatic-Reboot "true";
          Unattended-Upgrade::Automatic-Reboot-WithUsers "true";
          Unattended-Upgrade::Automatic-Reboot-Time "04:30";
        mode: '0644'

    - name: Enable periodic apt updates
      ansible.builtin.copy:
        dest: /etc/apt/apt.conf.d/20auto-upgrades
        content: |
          APT::Periodic::Update-Package-Lists "1";
          APT::Periodic::Unattended-Upgrade "1";
          APT::Periodic::AutocleanInterval "7";
        mode: '0644'

    - name: Deploy production index.php
      ansible.builtin.copy:
        dest: /var/www/html/index.php
        owner: www-data
        group: www-data
        mode: '0644'
        content: |
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="utf-8">
            <title>Live on Oracle Cloud Always Free</title>
            <style>
              body{font-family:system-ui,sans-serif;text-align:center;padding:4rem;background:#0f172a;color:#e2e8f0;}
              h1{font-size:3rem;margin:2rem 0;}
              p{font-size:1.2rem;}
              .badge{background:#10b981;padding:0.5rem 1rem;border-radius:999px;color:white;display:inline-block;margin:1rem;}
            </style>
          </head>
          <body>
            <h1>Success! It works.</h1>
            <p>Arm/AMD-powered LAMP + PostgreSQL 16 stack</p>
            <div class="badge">Running on Always Free Tier – 100% working</div>
            <p><strong>IP:</strong> <?php echo $_SERVER['SERVER_ADDR']; ?> | <strong>Host:</strong> <?php echo gethostname(); ?></p>
            <p>PHP <?php echo phpversion(); ?> • Apache • Ubuntu 22.04</p>
          </body>
          </html>
      notify: Restart Apache

    - name: Final Apache restart
      ansible.builtin.systemd:
        name: apache2
        state: restarted

    - name: Ensure services are running
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop:
        - apache2
        - postgresql

  handlers:
    - name: Restart Apache
      ansible.builtin.systemd:
        name: apache2
        state: restarted
